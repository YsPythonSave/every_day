# 爬虫`js`算法解析处理




## 涉及到的相关内容



### 	`js`常见的加密算法剖析

- 线性散列的`Md5`算法
- 对称加密`DES`/`AES`算法
- 非对称加密算法`RSA`
- `base64`伪加密
- `https`证书秘钥加密

##  可以处理的爬虫问题

- 模拟登录中密码加密和其他请求参数加密处理
- 动态加载且加密数据的捕获和破解
- ==重点==:找寻到`js`算法加密和解密相关流程的编码与处理套路/技巧,大幅度提升处理相关问题的效率.



---



# 常见的加密算法

## `Md5`加密

- 线性散列算法,产生`128位(16字节)`的散列值



### 解密

- 常规讲`MD5`是不存在解密的,但是理论上是可以进行反向暴力破解.
-  破解方式为不同数据进项加密后,跟已有的加密数据进行对比,由此来寻找规律
- ==注意==:破解MD5密码需要考虑破解成本(时间和机器性能),假设破解需要100年,那么该密码就是安全的



## 增加破解成本的方法(方法甚多,举例常用的)

- 使用一段无意义且随机的私匙进行`MD5`加密会生成一个加密串,我们暂且称之为串1
- 将要加密的数据跟串1进行拼接,在进行一次`MD5`,这是会生成串2
- 将串2在进行`MD5`加密,这是生成的串3就是我们加密后的数据.



## 我们在注册账号是的密码一般都是用的`MD5`加密



---



## `DES/AES`加密

- `DES`全称`Data Encryption Standard`,即数据库加密标准,是一种使用秘钥加密的算法,该算法是一种对称加密,其加密运算,解密运算需要使用的是同样的秘钥(一组字符串)即可
- ==注意==: 
	- 现在用`AES`这个标准来代替原本的`DES`
	- `AES`和`DES`的区别
		- 加密后密文长度的不同:
			- `DES`加密后密文长度是8的整倍数
			- `AES`加密后密文长度是16的整倍数
		- 应用场景的不同:
			- 企业级开发使用`DES`足够安全
			- 如果要求高使用`AES`
		- `EDS`和`AES`切换只需要修改`CryptoJS.AES  <=> CryptoJS.DES`
	- 使用`DES`和`AES`进行数据交互时要求双方都拥有相同的私匙

### 破解方法

- 暴力破解
- `DES`如果使用58位秘钥,则可能的秘钥数量时2的56次方个.只要计算足够强大时可以破解的



---



## `RSA`加密

- `REA`加密是一种非对称加密算法.在公开秘钥加密和电子商业中`RAS`被广泛使用

### 非对称加密算法:

- 非对称加密算法需要两个秘钥:
	- 公开密钥(`pubilckey`:简称公钥)
	- 私有秘钥(`privatekey`:简称私钥)
	- 公钥与私钥是一对,如果用公钥对数据进行加密,只有用对应的私钥才能解密.因为加密和解密使用的是两个不同的秘钥,所以这种算法叫做非对称加密算法.

### ==注意==

- 使用时都是使用公匙加密使用私匙解密.公匙可以公开,私匙自己保留.
- 算法强度复杂,安全性依赖于算法与秘钥但是由于其算法复杂,而使得加密解密速度没有对称加密解密的速度快

### 使用流程和场景介绍

- 假设`abc`三方之间互相要进行加密通信.大家使用公匙加密,读取信息时使用各自对应的私匙进项解密
- 用户输入的支付密码会通过`RAS`加密



---



## `base64`伪加密

- `base64`是一种用64个字符来表示任意二进制数据的方法.`base64`是一种编码方式而不是加密算法.只是看上去像加密而已
- `base64`使用`A-Z,a-z,0-9,+,/`这64个字符实现对数据进行加密.



---



## 拓展:https加密

- https是基于http和SSL/TSL实现的一个协议,他可以保证网络上传输的数据都是加密的,从而保证数据的安全
- 接下来我们从http协议开始,提出想法并逐步进行分析,最终实现`sttps`



1. http是不安全的

	- > 在https诞生之前,所有网站都使用http协议,而http协议在数据传输过程中都是明文,所以可能存在数据泄露和篡改
		>
		> ![image-20210603164551878](https://cdn.jsdelivr.net/gh/yanshaung/pic/image-20210603164551878.png)

2. 使用对称秘钥进行加密

	- > 为了防止数据泄露和篡改,我们对数据进行加密,如:生成一个对称密码
		>
		> [DKUFNAF897123F],将对称秘钥分别交给服务器和浏览器端,他们之间传输的数据都是用对称进行加密和解密
		>
		> ![image-20210603165554459](https://cdn.jsdelivr.net/gh/yanshaung/pic/image-20210603165554459.png)

	- 不可取,黑客一旦拦截秘钥,加密内容形同虚设

3. 非对称秘钥加密和动态对称秘钥

	- > 为了解决对称秘钥动态性以及让客户端和服务器端安全的获取对称秘钥,可以引入非对称秘钥机制.
		>
		> ![image-20210603170414437](https://cdn.jsdelivr.net/gh/yanshaung/pic/image-20210603170414437.png)
		>
		> ==注意==:4.应为客户端获取公钥

	- 不可取,无法保证客户端拿到的公钥一定是服务器端所发送的

4. CA证书的应用

	- > 使用CA证书可以解决黑客劫持的问题.
		>
		> ![image-20210603172155193](https://cdn.jsdelivr.net/gh/yanshaung/pic/image-20210603172155193.png)



---



# 实操

## 微信公众平台`js`算法逆向



### ==步骤==

1. 打开微信公众平台

2. 输入登录信息

3. 点击登录之后抓包

4. 解析`data`密码的加密算法

5. 点击检查右上角三个点`search`搜索加密的变量.假设变量名字为pwd

6. 找到`.js`文件

7. 文件内搜索`pwd`

8. 感觉类似加密的代码打上断点

9. 找到加密算法的位置

10. 找到整个加密算法过程

11. 使用发条调试工具检查`js`代码是否可以完整运行

12. > 环境安装:
	>
	> > 1. `nodejs`开发环境[^网上搜索相关教程]
	> > 2. `pip install PYExecJs`

13. 把完美运行的`js`代码复制到python运行文件以`.js`结尾

14. `pyhton`调用该文件

15. 反加密完成



### `js`代码

- > 发条`js`调试工具

	> - > 1. 假如单个数据未调用
	> 	> 2. 参考第一行
	> 	> 3. 生成一个新的变量
	>
	> - > 传入数据方法
	> 	>
	> 	> ![image-20210603215108320](https://cdn.jsdelivr.net/gh/yanshaung/pic/image-20210603215108320.png)

	> ```js
	> var n = {}
	> 
	> function d(e, t) {
	> var n = (65535 & e) + (65535 & t);
	> return (e >> 16) + (t >> 16) + (n >> 16) << 16 | 65535 & n
	> }
	> function s(e, t, n, o, i, r) {
	> return d((a = d(d(t, e), d(o, r))) << (s = i) | a >>> 32 - s, n);
	> var a, s
	> }
	> function p(e, t, n, o, i, r, a) {
	> return s(t & n | ~t & o, e, t, i, r, a)
	> }
	> function f(e, t, n, o, i, r, a) {
	> return s(t & o | n & ~o, e, t, i, r, a)
	> }
	> function m(e, t, n, o, i, r, a) {
	> return s(t ^ n ^ o, e, t, i, r, a)
	> }
	> function h(e, t, n, o, i, r, a) {
	> return s(n ^ (t | ~o), e, t, i, r, a)
	> }
	> function c(e, t) {
	> e[t >> 5] |= 128 << t % 32,
	> e[14 + (t + 64 >>> 9 << 4)] = t;
	> var n, o, i, r, a, s = 1732584193,
	> c = -271733879,
	> u = -1732584194,
	> l = 271733878;
	> for (n = 0; n < e.length; n += 16) s = p(o = s, i = c, r = u, a = l, e[n], 7, -680876936),
	> l = p(l, s, c, u, e[n + 1], 12, -389564586),
	> u = p(u, l, s, c, e[n + 2], 17, 606105819),
	> c = p(c, u, l, s, e[n + 3], 22, -1044525330),
	> s = p(s, c, u, l, e[n + 4], 7, -176418897),
	> l = p(l, s, c, u, e[n + 5], 12, 1200080426),
	> u = p(u, l, s, c, e[n + 6], 17, -1473231341),
	> c = p(c, u, l, s, e[n + 7], 22, -45705983),
	> s = p(s, c, u, l, e[n + 8], 7, 1770035416),
	> l = p(l, s, c, u, e[n + 9], 12, -1958414417),
	> u = p(u, l, s, c, e[n + 10], 17, -42063),
	> c = p(c, u, l, s, e[n + 11], 22, -1990404162),
	> s = p(s, c, u, l, e[n + 12], 7, 1804603682),
	> l = p(l, s, c, u, e[n + 13], 12, -40341101),
	> u = p(u, l, s, c, e[n + 14], 17, -1502002290),
	> s = f(s, c = p(c, u, l, s, e[n + 15], 22, 1236535329), u, l, e[n + 1], 5, -165796510),
	> l = f(l, s, c, u, e[n + 6], 9, -1069501632),
	> u = f(u, l, s, c, e[n + 11], 14, 643717713),
	> c = f(c, u, l, s, e[n], 20, -373897302),
	> s = f(s, c, u, l, e[n + 5], 5, -701558691),
	> l = f(l, s, c, u, e[n + 10], 9, 38016083),
	> u = f(u, l, s, c, e[n + 15], 14, -660478335),
	> c = f(c, u, l, s, e[n + 4], 20, -405537848),
	> s = f(s, c, u, l, e[n + 9], 5, 568446438),
	> l = f(l, s, c, u, e[n + 14], 9, -1019803690),
	> u = f(u, l, s, c, e[n + 3], 14, -187363961),
	> c = f(c, u, l, s, e[n + 8], 20, 1163531501),
	> s = f(s, c, u, l, e[n + 13], 5, -1444681467),
	> l = f(l, s, c, u, e[n + 2], 9, -51403784),
	> u = f(u, l, s, c, e[n + 7], 14, 1735328473),
	> s = m(s, c = f(c, u, l, s, e[n + 12], 20, -1926607734), u, l, e[n + 5], 4, -378558),
	> l = m(l, s, c, u, e[n + 8], 11, -2022574463),
	> u = m(u, l, s, c, e[n + 11], 16, 1839030562),
	> c = m(c, u, l, s, e[n + 14], 23, -35309556),
	> s = m(s, c, u, l, e[n + 1], 4, -1530992060),
	> l = m(l, s, c, u, e[n + 4], 11, 1272893353),
	> u = m(u, l, s, c, e[n + 7], 16, -155497632),
	> c = m(c, u, l, s, e[n + 10], 23, -1094730640),
	> s = m(s, c, u, l, e[n + 13], 4, 681279174),
	> l = m(l, s, c, u, e[n], 11, -358537222),
	> u = m(u, l, s, c, e[n + 3], 16, -722521979),
	> c = m(c, u, l, s, e[n + 6], 23, 76029189),
	> s = m(s, c, u, l, e[n + 9], 4, -640364487),
	> l = m(l, s, c, u, e[n + 12], 11, -421815835),
	> u = m(u, l, s, c, e[n + 15], 16, 530742520),
	> s = h(s, c = m(c, u, l, s, e[n + 2], 23, -995338651), u, l, e[n], 6, -198630844),
	> l = h(l, s, c, u, e[n + 7], 10, 1126891415),
	> u = h(u, l, s, c, e[n + 14], 15, -1416354905),
	> c = h(c, u, l, s, e[n + 5], 21, -57434055),
	> s = h(s, c, u, l, e[n + 12], 6, 1700485571),
	> l = h(l, s, c, u, e[n + 3], 10, -1894986606),
	> u = h(u, l, s, c, e[n + 10], 15, -1051523),
	> c = h(c, u, l, s, e[n + 1], 21, -2054922799),
	> s = h(s, c, u, l, e[n + 8], 6, 1873313359),
	> l = h(l, s, c, u, e[n + 15], 10, -30611744),
	> u = h(u, l, s, c, e[n + 6], 15, -1560198380),
	> c = h(c, u, l, s, e[n + 13], 21, 1309151649),
	> s = h(s, c, u, l, e[n + 4], 6, -145523070),
	> l = h(l, s, c, u, e[n + 11], 10, -1120210379),
	> u = h(u, l, s, c, e[n + 2], 15, 718787259),
	> c = h(c, u, l, s, e[n + 9], 21, -343485551),
	> s = d(s, o),
	> c = d(c, i),
	> u = d(u, r),
	> l = d(l, a);
	> return [s, c, u, l]
	> }
	> function u(e) {
	> var t, n = "";
	> for (t = 0; t < 32 * e.length; t += 8) n += String.fromCharCode(e[t >> 5] >>> t % 32 & 255);
	> return n
	> }
	> function l(e) {
	> var t, n = [];
	> for (n[(e.length >> 2) - 1] = void 0, t = 0; t < n.length; t += 1) n[t] = 0;
	> for (t = 0; t < 8 * e.length; t += 8) n[t >> 5] |= (255 & e.charCodeAt(t / 8)) << t % 32;
	> return n
	> }
	> function o(e) {
	> var t, n, o = "0123456789abcdef",
	> i = "";
	> for (n = 0; n < e.length; n += 1) t = e.charCodeAt(n),
	> i += o.charAt(t >>> 4 & 15) + o.charAt(15 & t);
	> return i
	> }
	> function i(e) {
	> return unescape(encodeURIComponent(e))
	> }
	> function r(e) {
	> return u(c(l(t = i(e)), 8 * t.length));
	> var t
	> }
	> function a(e, t) {
	> return function(e, t) {
	>     var n, o, i = l(e),
	>     r = [],
	>     a = [];
	>     for (r[15] = a[15] = void 0, 16 < i.length && (i = c(i, 8 * e.length)), n = 0; n < 16; n += 1) r[n] = 909522486 ^ i[n],
	>     a[n] = 1549556828 ^ i[n];
	>     return o = c(r.concat(l(t)), 512 + 8 * t.length),
	>     u(c(a.concat(o), 640))
	> } (i(e), i(t))
	> }
	> function getPwd(e, t, n) {
	> return t ? n ? a(t, e) : o(a(t, e)) : n ? r(e) : o(r(e))
	> }
	> ```



---



### `python`代码

> ```pyhton
> import execjs
> 
> # 1.实例化一个nade对象
> node = execjs.get()
> 
> # 2.js源文件编译
> ctx = node.compile(open('wechat.js',encoding='utf-8').read())
> 
> # 3.执行js函数
> mima = str(input('请输入密码:'))
> funName = 'getPwd("{0}")'.format(mima)
> pwd = ctx.eval(funName)
> print(pwd)
> ```



---



## STEAM密码加密逆向







---



# 总结

## 如何确定加密算法

- > md5加密 => 十六进制 => 位数为16位或32位

- > 加密数据过长首先判断是否是`AES` `DES`或者是`RSA`



## js逆向操作步骤

1. `PyExecjs`[^python模块]

	- 实现使用python代码执行`js`代码

	- > 环境安装:
		>
		> > 1. `nodejs`开发环境[^网上搜索相关教程]
		> > 2. `pip install PYExecJs`

2. 打断点

3. > 使用发条调试工具
	>
	> 代码调试时,如果发现了相关变量的缺失,一般给其定义成空字典



---



## `AES` `DES` 和`RSA`算法操作步骤

1. > 首先确定`Data`中的值是否为固定的值
	>
	> > if:
	> >
	> > ​	值为固定的,那么不用管它直接复制就行
	> >
	> > else:
	> >
	> > ​	进行多次抓包,把每次抓包的值进行对比看是否有变化

2. 

